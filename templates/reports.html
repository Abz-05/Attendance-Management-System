{% extends "base.html" %}

{% block title %}Overall Analytics{% endblock %}

{% block content %}
<div class="card">
    <h1 class="card-title">ğŸ“Š Individual Performance Insights âœ¨</h1>
    <p style="color: var(--text-secondary); margin-bottom: 2.5rem; font-size: 1.1rem;">Deep dive into student attendance patterns and consistency ğŸ”</p>

    <div style="display: flex; gap: 2rem; align-items: flex-end; flex-wrap: wrap; margin-bottom: 3rem;">
        <div class="form-group" style="flex: 1; min-width: 300px; margin-bottom: 0;">
            <label for="student-search">ğŸ‘¤ Select a Student from the Class</label>
            <select id="student-search" onchange="loadStudentReport()" style="background: rgba(255,255,255,0.05);">
                <option value="">-- Start Typing Name or Reg No --</option>
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label>ğŸ“ˆ Visualization Style</label>
            <select id="report-chart-type" onchange="renderStudentChart()" style="background: rgba(255,255,255,0.05);">
                <option value="line">Line Graph â€¢ Trend ğŸ“‰</option>
                <option value="bar">Bar Chart â€¢ Metrics ğŸ“Š</option>
                <option value="pie">Pie Chart â€¢ Summary ğŸ¥§</option>
            </select>
        </div>
    </div>

    <div id="report-container" style="display: none;">
        <!-- Header Info Injected via JS -->
        
        <div class="grid-stats">
            <div class="card stat-card" style="border-bottom: 4px solid var(--primary);">
                <div class="stat-icon">ğŸ“š</div>
                <span class="stat-value" id="res-total">0</span>
                <span class="stat-label">Total Periods</span>
            </div>
            <div class="card stat-card" style="border-bottom: 4px solid var(--success);">
                <div class="stat-icon">âœ…</div>
                <span class="stat-value" id="res-present" style="color: var(--success);">0</span>
                <span class="stat-label">Present</span>
            </div>
            <div class="card stat-card" style="border-bottom: 4px solid var(--error);">
                <div class="stat-icon">âŒ</div>
                <span class="stat-value" id="res-absent" style="color: var(--error);">0</span>
                <span class="stat-label">Absent</span>
            </div>
            <div class="card stat-card" style="border-bottom: 4px solid var(--warning);">
                <div class="stat-icon">âš¡</div>
                <span class="stat-value" id="res-percent" style="color: var(--warning);">0%</span>
                <span class="stat-label">Consistency Score</span>
            </div>
        </div>

        <div class="card" style="margin-top: 3rem; background: rgba(0,0,0,0.2);">
            <h3 class="card-title">ğŸ“‰ Attendance Trend Mapping</h3>
            <div class="chart-container" style="height: 350px;">
                <canvas id="studentChart"></canvas>
            </div>
        </div>

        <div class="card" style="margin-top: 2rem;">
            <h3 class="card-title">ğŸ“œ Academic Attendance Log</h3>
            <div class="attendance-grid" id="history-container">
                <!-- History rows -->
            </div>
        </div>
    </div>
    
    <div id="no-selection-view" style="text-align: center; padding: 5rem 0;">
        <div style="font-size: 4rem; margin-bottom: 1.5rem;">ğŸ”</div>
        <h2 style="color: var(--text-secondary);">Select a student to view detailed analytical insights</h2>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let studentChart = null;
    let studentHistory = [];
    let studentSummary = null;

    async function loadStudents() {
        try {
            const response = await fetch('/api/students/list');
            const data = await response.json();
            if (data.success) {
                const select = document.getElementById('student-search');
                data.students.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = `${s.name} (${s.reg_no || '---'})`;
                    select.appendChild(opt);
                });
            }
        } catch (e) { console.error(e); }
    }

    async function loadStudentReport() {
        const studentId = document.getElementById('student-search').value;
        if (!studentId) {
            document.getElementById('report-container').style.display = 'none';
            document.getElementById('no-selection-view').style.display = 'block';
            return;
        }

        try {
            const response = await fetch(`/api/reports/summary/${studentId}`);
            const data = await response.json();

            if (data.success) {
                studentSummary = data.summary;
                const s = data.student;
                
                const profileHtml = `
                    <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 3rem; padding: 2.5rem; background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%); border-radius: 2rem; border: 1px solid var(--glass-border);">
                        <div style="width: 100px; height: 100px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 2rem; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: 900; box-shadow: 0 20px 40px -10px var(--primary-glow); transform: rotate(-3deg);">
                            ${s.name.charAt(0)}
                        </div>
                        <div style="flex: 1;">
                            <h2 style="font-size: 2.2rem; font-weight: 900; margin-bottom: 0.5rem; letter-spacing: -1px;">${s.name}</h2>
                            <div style="display: flex; gap: 1.5rem; color: var(--text-secondary); flex-wrap: wrap; font-weight: 500;">
                                <span><i class="fas fa-id-card" style="color: var(--primary);"></i> ${s.reg_no || 'N/A'}</span>
                                <span><i class="fas fa-phone" style="color: var(--accent);"></i> ${s.phone || 'N/A'}</span>
                                <span><i class="fas fa-envelope" style="color: var(--secondary);"></i> ${s.email || 'N/A'}</span>
                            </div>
                            <div style="margin-top: 1rem; padding: 0.5rem 1.2rem; background: var(--primary-glow); color: #fff; width: fit-content; border-radius: 1rem; font-weight: 800; font-size: 0.9rem;">
                                ğŸ¯ CURRENT CGPA: ${s.cgpa || 'N/A'}
                            </div>
                        </div>
                    </div>
                `;
                
                const container = document.getElementById('report-container');
                const existingProfile = document.getElementById('student-profile-header');
                if (existingProfile) existingProfile.remove();
                
                const profileDiv = document.createElement('div');
                profileDiv.id = 'student-profile-header';
                profileDiv.innerHTML = profileHtml;
                container.insertBefore(profileDiv, container.firstChild);

                document.getElementById('res-total').textContent = data.summary.total;
                document.getElementById('res-present').textContent = data.summary.present;
                document.getElementById('res-absent').textContent = data.summary.absent;
                document.getElementById('res-percent').textContent = data.summary.attendance_percentage + '%';
                
                await loadHistory(studentId);
                
                document.getElementById('report-container').style.display = 'block';
                document.getElementById('no-selection-view').style.display = 'none';
            }
        } catch (e) { console.error(e); }
    }

    async function loadHistory(studentId) {
        const response = await fetch(`/api/attendance/student/${studentId}`);
        const data = await response.json();
        if (data.success) {
            studentHistory = data.records;
            renderStudentChart();
            renderHistory();
        }
    }

    function renderStudentChart() {
        if (!studentHistory.length || !studentSummary) return;
        const type = document.getElementById('report-chart-type').value;
        const ctx = document.getElementById('studentChart').getContext('2d');
        if (studentChart) studentChart.destroy();

        if (type === 'pie') {
            studentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Present âœ…', 'Absent âŒ', 'Late ğŸ•’'],
                    datasets: [{
                        data: [studentSummary.present, studentSummary.absent, studentSummary.late],
                        backgroundColor: ['#10b981', '#f43f5e', '#fbbf24'],
                        borderWidth: 0,
                        hoverOffset: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#fff', font: { size: 14, weight: 'bold' } } } }
                }
            });
        } else {
            // Trend data (last 10 records)
            const subset = [...studentHistory].reverse().slice(-10);
            const labels = subset.map(r => r.date.split('-').slice(1).join('/'));
            const dataValues = subset.map(r => r.status === 'Present' ? 1 : (r.status === 'Late' ? 0.5 : 0));

            studentChart = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Attendance Status (1=P, 0.5=L, 0=A)',
                        data: dataValues,
                        backgroundColor: 'rgba(139, 92, 246, 0.3)',
                        borderColor: '#8b5cf6',
                        borderWidth: 4,
                        pointBackgroundColor: '#fff',
                        pointRadius: 6,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 1.1,
                            ticks: { 
                                color: '#94a3b8',
                                callback: (v) => v === 1 ? 'P âœ…' : (v === 0.5 ? 'L ğŸ•’' : (v === 0 ? 'A âŒ' : ''))
                            },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
    }

    function renderHistory() {
        const container = document.getElementById('history-container');
        container.innerHTML = '';
        
        studentHistory.forEach(r => {
            const row = document.createElement('div');
            row.className = 'student-row';
            const icon = r.status === 'Present' ? 'âœ…' : (r.status === 'Absent' ? 'âŒ' : 'ğŸ•’');
            const badgeClass = r.status === 'Present' ? 'badge-present' : (r.status === 'Absent' ? 'badge-absent' : 'badge-late');
            
            row.innerHTML = `
                <div class="student-info">
                    <div style="font-weight: 700;">ğŸ“… ${r.date} â€¢ Session ${r.period}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.3rem;">
                        <i class="fas fa-book-open" style="color: var(--primary);"></i> ${r.subject} 
                        <span style="margin: 0 0.5rem; opacity: 0.3;">|</span>
                        <i class="fas fa-user-tie" style="color: var(--accent);"></i> ${r.faculty_name}
                    </div>
                </div>
                <div>
                    <span class="badge ${badgeClass}">${icon} ${r.status}</span>
                </div>
            `;
            container.appendChild(row);
        });
    }

    loadStudents();
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Mark Attendance{% endblock %}

{% block content %}
<div class="card">
    <h1 class="card-title">ğŸ“ Digital Attendance Log âœ¨</h1>
    <p style="color: var(--text-secondary); margin-bottom: 3rem; font-size: 1.1rem;">Securely record departmental attendance for the Data Science Batch ğŸ§¬</p>

    <div class="grid-stats" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem;">
        <div class="form-group">
            <label for="faculty-select">ğŸ‘¨â€ğŸ« Faculty Member</label>
            <select id="faculty-select" style="background: rgba(139, 92, 246, 0.05); border-color: rgba(139, 92, 246, 0.2);">
                <option value="">-- Identify Faculty --</option>
            </select>
        </div>
        <div class="form-group">
            <label for="subject-display">ğŸ“– Active Course</label>
            <input type="text" id="subject-display" readonly placeholder="Choose faculty member..." style="background: rgba(0,0,0,0.2); cursor: not-allowed; border-style: dashed;">
        </div>
        <div class="form-group">
            <label for="period-select">ğŸ•’ Class Session</label>
            <select id="period-select" style="background: rgba(6, 182, 212, 0.05); border-color: rgba(6, 182, 212, 0.2);">
                <option value="1">Period 1 (09:00 - 09:50)</option>
                <option value="2">Period 2 (09:50 - 10:40)</option>
                <option value="3">Period 3 (11:00 - 11:50)</option>
                <option value="4">Period 4 (11:50 - 12:40)</option>
                <option value="5">Period 5 (01:30 - 03:10)</option>
            </select>
        </div>
        <div class="form-group">
            <label for="date-select">ğŸ“… Selection Date</label>
            <input type="date" id="date-select" style="background: rgba(236, 72, 153, 0.05); border-color: rgba(236, 72, 153, 0.2);">
        </div>
    </div>

    <div class="attendance-section" style="margin-top: 3rem; display: none;" id="attendance-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem;">
            <h3>Class Roll Call (23 Students) ğŸ“‹</h3>
            <div style="display: flex; gap: 0.8rem;">
                <button class="btn btn-primary" onclick="markAll('Present')" style="padding: 0.6rem 1.2rem; font-size: 0.85rem;">
                    âœ… All Present
                </button>
                <button class="btn" onclick="markAll('Absent')" style="padding: 0.6rem 1.2rem; font-size: 0.85rem; background: var(--error); color: white;">
                    âŒ All Absent
                </button>
            </div>
        </div>
        
        <div class="attendance-grid" id="students-container">
            <!-- Students will be loaded here -->
        </div>

        <div style="margin-top: 4rem; text-align: right; position: sticky; bottom: 2rem;">
            <button class="btn btn-primary" id="submit-btn" onclick="submitAttendance()" style="padding: 1.5rem 3.5rem; font-size: 1.2rem; border-radius: 2rem; box-shadow: 0 20px 40px var(--primary-glow);">
                ğŸš€ Submit Session Logs
            </button>
        </div>
    </div>
    
    <div id="setup-instruction" style="text-align: center; padding: 4rem 0;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ‘¨â€ğŸ«</div>
        <h2 style="color: var(--text-secondary); font-weight: 500;">Please select a faculty member to begin roll call</h2>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let studentsData = [];
    let facultyData = [];
    const dateInput = document.getElementById('date-select');
    dateInput.valueAsDate = new Date();

    async function loadFaculty() {
        try {
            const response = await fetch('/api/faculty/list');
            const data = await response.json();
            if (data.success) {
                facultyData = data.faculty;
                const select = document.getElementById('faculty-select');
                facultyData.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f.id;
                    opt.textContent = `${f.name} âœ¨`;
                    select.appendChild(opt);
                });
            }
        } catch (e) { console.error(e); }
    }

    async function loadStudents() {
        try {
            const response = await fetch('/api/students/list');
            const data = await response.json();
            if (data.success) {
                studentsData = data.students;
                renderStudents();
                document.getElementById('attendance-section').style.display = 'block';
                document.getElementById('setup-instruction').style.display = 'none';
            }
        } catch (e) { console.error(e); }
    }

    function renderStudents() {
        const container = document.getElementById('students-container');
        container.innerHTML = '';
        
        studentsData.forEach(student => {
            const row = document.createElement('div');
            row.className = 'student-row';
            row.innerHTML = `
                <div class="student-info">
                    <div style="font-weight: 800; font-size: 1.1rem; display: flex; align-items: center; gap: 0.8rem;">
                        <span style="width: 35px; height: 35px; background: rgba(255,255,255,0.05); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: var(--primary); border: 1px solid var(--glass-border);">${student.name.charAt(0)}</span>
                        ${student.name} 
                        <span style="font-size: 0.8rem; color: var(--primary); opacity: 0.7; font-weight: 400;">[${student.reg_no || '---'}]</span>
                    </div>
                </div>
                <div class="status-options" data-student-id="${student.id}">
                    <button class="status-btn present active" onclick="setStatus(${student.id}, 'Present')">âœ… Present</button>
                    <button class="status-btn absent" onclick="setStatus(${student.id}, 'Absent')">âŒ Absent</button>
                    <button class="status-btn late" onclick="setStatus(${student.id}, 'Late')">ğŸ•’ Late</button>
                </div>
            `;
            container.appendChild(row);
        });
    }

    function setStatus(studentId, status) {
        const btnGroup = document.querySelector(`.status-options[data-student-id="${studentId}"]`);
        btnGroup.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
        btnGroup.querySelector(`.${status.toLowerCase()}`).classList.add('active');
    }

    function markAll(status) {
        studentsData.forEach(s => setStatus(s.id, status));
    }

    document.getElementById('faculty-select').addEventListener('change', (e) => {
        const facultyId = e.target.value;
        const subjectInput = document.getElementById('subject-display');
        
        if (facultyId) {
            const faculty = facultyData.find(f => f.id == facultyId);
            subjectInput.value = faculty ? faculty.subject : '';
            if (studentsData.length === 0) loadStudents();
        } else {
            subjectInput.value = '';
            document.getElementById('attendance-section').style.display = 'none';
            document.getElementById('setup-instruction').style.display = 'block';
        }
    });

    async function submitAttendance() {
        const facultyId = document.getElementById('faculty-select').value;
        const subject = document.getElementById('subject-display').value;
        const period = document.getElementById('period-select').value;
        const date = document.getElementById('date-select').value;
        
        const records = [];
        document.querySelectorAll('.status-options').forEach(group => {
            const studentId = group.getAttribute('data-student-id');
            const statusLabel = group.querySelector('.active').textContent.split(' ')[1];
            records.push({ student_id: studentId, status: statusLabel });
        });

        const btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Sync...';

        try {
            const response = await fetch('/api/attendance/mark_bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ faculty_id: facultyId, subject: subject, period: period, date: date, records: records })
            });
            
            const result = await response.json();
            if (result.success) {
                showAlert('âœ¨ Attendance Logs Synced Successfully!');
            } else {
                showAlert('âŒ Error: ' + result.message, 'error');
            }
        } catch (e) {
            showAlert('ğŸŒ Connection Error', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'ğŸš€ Submit Session Logs';
        }
    }

    loadFaculty();
</script>
{% endblock %}
